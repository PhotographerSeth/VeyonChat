name: Build Veyon Plugin

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    # 1. Check out your plugin's source code
    - name: Check out plugin repository
      uses: actions/checkout@v4
      with:
        path: plugin_src

    # 2. Install the required version of Qt
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'

    # 3. Check out the official Veyon source code
    - name: Check out Veyon repository
      uses: actions/checkout@v4
      with:
        repository: veyon/veyon
        path: veyon_src
        ref: 'v4.9.7'
        fetch-depth: 0

    # 4. CORRECTED FIX: Modify the Veyon build script
    - name: Patch Veyon CMakeLists
      shell: pwsh
      run: |
        $cmakeFile = "veyon_src/CMakeLists.txt"
        (Get-Content $cmakeFile) -replace 'find_package\(Qt6', 'find_package(Qt5' | Set-Content $cmakeFile
        echo "Successfully patched CMakeLists.txt to use Qt5."

    # 5. NEW: Verify that the patch was successful
    - name: Verify Patch
      shell: pwsh
      run: |
        echo "Verifying contents of veyon_src/CMakeLists.txt:"
        Get-Content veyon_src/CMakeLists.txt | Select-String -Pattern "find_package"

    # 6. Build Veyon from source
    - name: Build Veyon
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
        cd veyon_src
        set CMAKE_PREFIX_PATH=%Qt5_Dir%
        cmake -S . -B build -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release

    # 7. Build the VeyonChat plugin
    - name: Build Plugin
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
        cd plugin_src
        set VEYON_BUILD_DIR=%GITHUB_WORKSPACE%\veyon_src\build
        qmake VeyonChat.pro
        nmake /f Makefile.Release
      env:
        QT_PLUGIN_PATH: ${{ env.Qt5_Dir }}\plugins

    # 8. Package the compiled files into a zip archive
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: VeyonChat-Plugin-Windows
        path: |
          plugin_src/release/VeyonChat.dll
          plugin_src/plugin.json