name: Build Veyon + VeyonChat (Windows)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      VEYON_VERSION: "4.9.7"
      QT_VERSION: "6.8.3"
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      # 1) Checkout Veyon source
      - name: Checkout Veyon
        uses: actions/checkout@v4
        with:
          repository: veyon/veyon
          ref: "v${{ env.VEYON_VERSION }}"
          path: veyon
          fetch-depth: 0

      # 2) Checkout YOUR plugin into veyon/plugins/chat
      - name: Checkout VeyonChat into plugins/chat
        uses: actions/checkout@v4
        with:
          path: veyon/plugins/chat

      # 3) Install Qt (match whatever Veyon expects in your version)
      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2022_64
          # If Veyon needs more Qt modules than Widgets, add them here.
          # Common add-ons: qtbase qttools qtsvg qttranslations
          # modules: "qttools qtsvg"

      # 4) Install QCA (and friends) via vcpkg so Qca-qt6Config.cmake exists
      - name: Setup vcpkg (QCA)
        uses: microsoft/vcpkg-action@v1
        with:
          pkgs: qca
          triplet: x64-windows

      # 5) Configure Veyon using the vcpkg toolchain + Qt prefix
      - name: Configure Veyon
        shell: pwsh
        run: >
          cmake -S veyon -B veyon/build
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}\scripts\buildsystems\vcpkg.cmake"
          -DCMAKE_PREFIX_PATH="${{ env.VCPKG_ROOT }}\installed\x64-windows;${{ steps.install-qt.outputs.Qt6_DIR }}"

      # 6) Build Veyon (this will also build your in-tree plugin if Veyon picks it up)
      - name: Build Veyon
        shell: pwsh
        run: >
          cmake --build veyon/build --config Release --parallel

      # 7) (Optional) If Veyon doesn't automatically add plugins/chat, build it explicitly
      - name: Build Chat Plugin (explicit)
        shell: pwsh
        run: >
          cmake --build veyon/build --config Release --target chat
        continue-on-error: true

      # 8) (Optional) Upload artifacts (adjust paths after you confirm where outputs land)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: veyon-windows-release
          path: |
            veyon/build/**/Release/*.exe
            veyon/build/**/Release/*.dll
            veyon/build/**/Release/*.pdb
            veyon/build/**/plugins/**/*
          if-no-files-found: warn
